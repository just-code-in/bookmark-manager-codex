#!/usr/bin/env bash
set -euo pipefail

staged_files=()
while IFS= read -r -d '' file; do
  staged_files+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACMR -z)

if [ "${#staged_files[@]}" -eq 0 ]; then
  exit 0
fi

secret_pattern="AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|sk-[A-Za-z0-9]{20,}|xox[baprs]-[A-Za-z0-9-]{10,}|-----BEGIN (RSA|EC|OPENSSH|DSA|PGP|PRIVATE) KEY-----|[Bb]earer[[:space:]]+[A-Za-z0-9._~+/-]{16,}|[Aa]uthorization[[:space:]]*:[[:space:]]*[Bb]earer[[:space:]]+[A-Za-z0-9._~+/-]+=*|([Aa][Pp][Ii][_ -]?[Kk][Ee][Yy]|[Ss][Ee][Cc][Rr][Ee][Tt]|[Tt][Oo][Kk][Ee][Nn]|[Cc][Ll][Ii][Ee][Nn][Tt][_ -]?[Ss][Ee][Cc][Rr][Ee][Tt]|[Pp][Rr][Ii][Vv][Aa][Tt][Ee][_ -]?[Kk][Ee][Yy])[[:space:]]*[:=][[:space:]]*[\"'][^\"']{8,}[\"']"

tmp_file="$(mktemp)"
trap 'rm -f "$tmp_file"' EXIT

has_secrets=0

for file in "${staged_files[@]}"; do
  if git show ":$file" | LC_ALL=C grep -nE "$secret_pattern" >"$tmp_file" 2>/dev/null; then
    echo "Potential secret detected in staged file: $file"
    head -n 5 "$tmp_file"
    echo
    has_secrets=1
  fi
done

if [ "$has_secrets" -ne 0 ]; then
  echo "Commit blocked: remove or move secrets to environment variables."
  exit 1
fi

exit 0
